# Selection Configuration for B+ → pK⁻Λ̄ K+ Analysis
# This file defines all selection cuts applied to the data

[metadata]
description = "Selection cuts for B+ → Λ0 h1 h2 decay channel"
version = "1.0"
date = "2025-10-24"

# Derived/Calculated branches that need to be computed from existing branches
[derived_branches]
# Format: name = "expression"
# These will be evaluated using the events data
delta_z = "L0_ENDVERTEX_Z - Bu_ENDVERTEX_Z"
lambda_mass_diff = "abs(L0_MM - 1115.683)"
kk_product = "h1_ProbNNk * h2_ProbNNk"
# 3-body PID product (proton * h1 * h2)
pid_product = "p_MC15TuneV1_ProbNNp * h1_ProbNNk * h2_ProbNNk"
# Lambda corrected B+ mass (for B_region selection)
lambda_corrected_bu_mass = "Bu_MM - L0_MM + 1115.683"
# Lambda FD chi-squared (calculated from Delta_X, Delta_Y, Delta_Z)
# This is computed separately in selection.py

# Trigger Selection Cuts
[trigger]
enabled = true

  [trigger.L0]
  description = "L0 trigger requirement"
  expression = "(Bu_L0Global_TIS) | (Bu_L0HadronDecision_TOS)"
  
  [trigger.L1]
  description = "L1 trigger requirement"
  expression = "(Bu_Hlt1TrackMVADecision_TOS) | (Bu_Hlt1TwoTrackMVADecision_TOS)"
  
  [trigger.L2]
  description = "L2 trigger requirement"
  expression = "(Bu_Hlt2Topo2BodyDecision_TOS) | (Bu_Hlt2Topo3BodyDecision_TOS) | (Bu_Hlt2Topo4BodyDecision_TOS)"

# Proton Selection Cuts
[proton]
description = "Proton (p) selection cuts"

  [[proton.cuts]]
  name = "p_ProbNNp"
  branch = "p_MC15TuneV1_ProbNNp"
  operator = ">"
  value = 0.05
  description = "Proton PID probability"

# Lambda Selection Cuts
[lambda]
description = "Lambda (Λ0) selection cuts"

  [[lambda.cuts]]
  name = "lambda_delta_z"
  branch = "delta_z"  # This is a derived branch
  operator = ">"
  value = 20.0
  description = "ΔZ > 20 mm (Lambda decay vertex - B+ decay vertex)"
  
  [[lambda.cuts]]
  name = "lambda_FD_CHISQ"
  branch = "L0_FD_CHISQ"  # This is a derived branch (computed in selection.py)
  operator = ">"
  value = 45.0
  description = "Lambda flight distance χ² (calculated from Delta_X, Delta_Y, Delta_Z)"
  
  [[lambda.cuts]]
  name = "lambda_mass_window_lower"
  branch = "L0_MM"
  operator = ">"
  value = 1111.0
  description = "Lambda mass > 1111 MeV/c² (lower bound)"
  
  [[lambda.cuts]]
  name = "lambda_mass_window_upper"
  branch = "L0_MM"
  operator = "<"
  value = 1121.0
  description = "Lambda mass < 1121 MeV/c² (upper bound)"
  
  [[lambda.cuts]]
  name = "lambda_proton_ProbNNp"
  branch = "Lp_MC15TuneV1_ProbNNp"
  operator = ">"
  value = 0.2
  description = "Lambda daughter proton PID probability"

# Kaon Selection Cuts (h1 and h2)
[kaon]
description = "Kaon (h1, h2) selection cuts"

  [[kaon.cuts]]
  name = "pid_product"
  branch = "pid_product"  # This is a derived branch: p * h1 * h2 PID product
  operator = ">"
  value = 0.50
  description = "Product of p, h1, and h2 PID probabilities (p_ProbNNp × h1_ProbNNk × h2_ProbNNk)"
  
  # Individual kaon cuts for reference (not applied by default, but can be used)
  [[kaon.cuts]]
  name = "h1_ProbNNk"
  branch = "h1_ProbNNk"
  operator = ">"
  value = 0.2
  description = "h1 kaon PID probability"
  enabled = false  # Set to true to apply this cut
  
  [[kaon.cuts]]
  name = "h2_ProbNNk"
  branch = "h2_ProbNNk"
  operator = ">"
  value = 0.2
  description = "h2 kaon PID probability"
  enabled = false  # Set to true to apply this cut

# B+ Selection Cuts
[bplus]
description = "B+ meson selection cuts"

  [[bplus.cuts]]
  name = "Bu_PT"
  branch = "Bu_PT"
  operator = ">"
  value = 3000.0
  description = "B+ transverse momentum > 3000 MeV/c"
  
  [[bplus.cuts]]
  name = "Bu_DTF_chi2"
  branch = "Bu_DTF_chi2"
  operator = "<"
  value = 30.0
  description = "B+ DTF χ² < 30"
  
  [[bplus.cuts]]
  name = "Bu_DTF_status"
  branch = "Bu_DTF_status"
  operator = "=="
  value = 0
  description = "B+ DTF converged successfully"
  
  [[bplus.cuts]]
  name = "Bu_IPCHI2"
  branch = "Bu_IPCHI2_OWNPV"
  operator = "<"
  value = 10.0
  description = "B+ impact parameter χ² < 10"
  
  [[bplus.cuts]]
  name = "Bu_FDCHI2"
  branch = "Bu_FDCHI2_OWNPV"
  operator = ">"
  value = 175.0
  description = "B+ flight distance χ² > 175"
  
  [[bplus.cuts]]
  name = "Bu_mass_window_lower"
  branch = "lambda_corrected_bu_mass"  # This is a derived branch
  operator = ">"
  value = 5255.0
  description = "Lambda-corrected B+ mass > 5255 MeV/c² (B_region lower bound)"
  enabled = false  # Set to true to apply B_region cut
  
  [[bplus.cuts]]
  name = "Bu_mass_window_upper"
  branch = "lambda_corrected_bu_mass"  # This is a derived branch
  operator = "<"
  value = 5305.0
  description = "Lambda-corrected B+ mass < 5305 MeV/c² (B_region upper bound)"
  enabled = false  # Set to true to apply B_region cut

# Cut Set Selection
[cut_set]
# Choose which set of cuts to apply: "tight", "tighter", or "loose"
active = "tighter"  # Default to tighter cuts from old notebook

# Tight Cuts (Based on old KpKm_explore.ipynb notebook)
# tight_cuts = good_Lambda_sep_100 & (Bu_PT>3500) & (prodProbKK>0.5) & (p_ProbNNp>0.5) & (Bu_FDCHI2_OWNPV>250.) & (Bu_IPCHI2_OWNPV<6) & good_Lambda_mass
[tight]
description = "Tight selection cuts from old notebook (without DTF chi2 cut)"

  [tight.proton]
  p_ProbNNp = 0.5  # Tighter than loose (0.05)
  
  [tight.lambda]
  delta_z = 5.0  # good_Lambda_sep_100: Delta_Z > 5
  FD_CHISQ = 100.0  # good_Lambda_sep_100: L0_FD_CHISQ > 100
  mass_window_lower = 1111.0  # good_Lambda_mass: L0_MM > 1111
  mass_window_upper = 1121.0  # good_Lambda_mass: L0_MM < 1121
  proton_ProbNNp = 0.2  # Default Lambda daughter proton cut
  
  [tight.kaon]
  # prodProbKK > 0.5 (product of two kaon PID probabilities)
  kk_product = 0.5
  
  [tight.bplus]
  PT = 3500.0  # Bu_PT > 3500
  DTF_chi2 = 999999.0  # No DTF chi2 cut in tight_cuts (effectively disabled)
  IPCHI2 = 6.0  # Bu_IPCHI2_OWNPV < 6
  FDCHI2 = 250.0  # Bu_FDCHI2_OWNPV > 250
  # B_region cuts (disabled by default)
  mass_window_lower = 5255.0
  mass_window_upper = 5305.0
  mass_window_enabled = true

# Tighter Cuts (Based on old KpKm_explore.ipynb notebook)
# tighter_cuts = tight_cuts & (Bu_DTF_chi2<40)
[tighter]
description = "Tighter selection cuts from old notebook (tight_cuts + DTF chi2 < 40)"

  [tighter.proton]
  p_ProbNNp = 0.5
  
  [tighter.lambda]
  delta_z = 5.0
  FD_CHISQ = 100.0
  mass_window_lower = 1111.0
  mass_window_upper = 1121.0
  proton_ProbNNp = 0.2
  
  [tighter.kaon]
  kk_product = 0.5
  
  [tighter.bplus]
  PT = 3500.0
  DTF_chi2 = 40.0  # Bu_DTF_chi2 < 40 (this is the key difference from tight)
  IPCHI2 = 6.0
  FDCHI2 = 250.0
  # B_region cuts (can be enabled for final plots)
  mass_window_lower = 5255.0
  mass_window_upper = 5305.0
  mass_window_enabled = true  # Disabled for higher statistics

# Loose Cuts (Based on K⁻K⁺ mode slides)
[loose]
description = "Loose selection cuts from K⁻K⁺ mode analysis"

  [loose.proton]
  p_ProbNNp = 0.05  # Basic proton identification
  
  [loose.lambda]
  delta_z = 5.0  # ΔZ > 5 mm (from slides)
  FDCHI2 = 250.0  # Lambda FD χ² > 250 (from slides)
  mass_window = 5.0  # |m(pπ⁻) - 1115.6| < 5 MeV (1111 < M < 1121)
  proton_ProbNNp = 0.3  # Λ_p ProbNNp > 0.3 (from slides summary table)
  
  [loose.kaon]
  pid_product = 0.20  # Looser than tight (0.50)
  
  [loose.bplus]
  PT = 3500.0  # B+ pT > 3500 MeV (from slides)
  DTF_chi2 = 40.0  # Looser than tight
  IPCHI2 = 6.0  # B+ IP χ² < 6 (from slides)
  FDCHI2 = 250.0  # B+ FD χ² > 250 (from slides)
