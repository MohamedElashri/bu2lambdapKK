# Snakefile — PID Product & Bu_DTF_chi2 Investigation
#
# Answers two diagnostic questions:
#   1. Why does the optimizer always choose PID_product > 0.0 (no cut)?
#   2. Does Bu_DTF_chi2 encode the Lambda mass constraint (redundancy check)?
#
# Usage:
#   cd analysis/studies/pid_dtf_investigation
#   uv run snakemake -j1
#
# Requires Step 2 cached data from the main pipeline.

ANALYSIS_DIR = "../.."
CONFIG_DIR = f"{ANALYSIS_DIR}/config"
CACHE_DIR = f"{ANALYSIS_DIR}/cache"
OUTPUT_DIR = "output"

configfile: f"{ANALYSIS_DIR}/snakemake_config.yaml"

rule all:
    input:
        f"{OUTPUT_DIR}/pid_fom_analysis.pdf",
        f"{OUTPUT_DIR}/dtf_lambda_redundancy.pdf",
        f"{OUTPUT_DIR}/pid_dtf_summary.csv",

rule pid_dtf_investigation:
    """PID product & Bu_DTF_chi2 diagnostic study.

    PID section:
      - Signal MC vs sideband background PID distributions
      - ε_signal / √ε_background curve: explains why FOM never improves with PID cuts
      - ROC-like curve (signal efficiency vs background rejection)
      - Individual PID variable distributions

    DTF section:
      - Scatter: DTF chi2 vs |L0_MM - PDG| (near-zero correlation = no Lambda constraint)
      - DTF chi2 before/after each Lambda cut (no shape change = independent variables)
      - Summary correlation table
    """
    input:
        f"{ANALYSIS_DIR}/analysis_output/.step2_complete",
    output:
        pid_plot=f"{OUTPUT_DIR}/pid_fom_analysis.pdf",
        dtf_plot=f"{OUTPUT_DIR}/dtf_lambda_redundancy.pdf",
        csv=f"{OUTPUT_DIR}/pid_dtf_summary.csv",
    params:
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "study_pid_dtf.py"
