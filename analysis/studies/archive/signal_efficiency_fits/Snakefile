# Snakefile — Signal Efficiency Fits Study (standalone)
#
# Fit M(B⁺) distributions with Crystal Ball (signal) + ARGUS (background)
# for "all events" and "events passing selection cuts" to extract signal
# efficiency via yield ratios.
#
# Usage:
#   cd analysis/studies/signal_efficiency_fits
#   uv run snakemake -j1
#
# Depends on Step 2 cached data/MC from the main pipeline.

# Paths relative to this study directory → main analysis/
ANALYSIS_DIR = "../.."
CONFIG_DIR = f"{ANALYSIS_DIR}/config"
CACHE_DIR = f"{ANALYSIS_DIR}/cache"
OUTPUT_DIR = "output"

configfile: f"{ANALYSIS_DIR}/snakemake_config.yaml"

rule all:
    input:
        f"{OUTPUT_DIR}/signal_efficiency_fits.pdf",
        f"{OUTPUT_DIR}/signal_efficiency_table.csv",

rule signal_efficiency_fits:
    """Fit M(B⁺) to extract signal efficiency from yield ratios.

    For each MC signal state and for Data:
      1. Fit M(B⁺) for all events → total signal yield
      2. Fit M(B⁺) for events passing selection cuts → passing signal yield
      3. Efficiency = N_pass / N_all (with proper error propagation)

    Requires Step 2 cached data from the main pipeline:
      cd analysis/ && uv run snakemake load_data -j1
    """
    input:
        # Sentinel from main pipeline Step 2
        f"{ANALYSIS_DIR}/analysis_output/.step2_complete",
    output:
        plot=f"{OUTPUT_DIR}/signal_efficiency_fits.pdf",
        csv=f"{OUTPUT_DIR}/signal_efficiency_table.csv",
    params:
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "study_signal_efficiency_fits.py"
