"""
Snakefile: Cross-Validation Optimizer Study

Splits data into odd/even halves by index parity, runs the 252-point
fit-based grid scan independently on each half, then cross-validates:
  - Odd-trained cuts applied to Even data  (odd→even)
  - Even-trained cuts applied to Odd data  (even→odd)

Consistency of optimal cuts + FOM_val/FOM_train ≈ 1 indicates low bias.

Depends on:
  - analysis_output/.step2_complete  (main pipeline Step 2 cache)
  - fit_based_optimizer/output/optimal_cuts.csv  (full-dataset reference)

Usage:
    cd analysis/studies/cross_validation_optimizer
    uv run snakemake -j1
"""

ANALYSIS_DIR      = "../.."
CONFIG_DIR        = f"{ANALYSIS_DIR}/config"
CACHE_DIR         = f"{ANALYSIS_DIR}/cache"
OUTPUT_DIR        = "output"
FIT_OPT_DIR       = f"{ANALYSIS_DIR}/studies/fit_based_optimizer"

configfile: f"{ANALYSIS_DIR}/snakemake_config.yaml"


rule all:
    input:
        f"{OUTPUT_DIR}/scan_odd.csv",
        f"{OUTPUT_DIR}/scan_even.csv",
        f"{OUTPUT_DIR}/crossval_summary.csv",
        f"{OUTPUT_DIR}/crossval_report.pdf",
        f"{OUTPUT_DIR}/fits/val_set1_odd2even.pdf",
        f"{OUTPUT_DIR}/fits/val_set1_even2odd.pdf",
        f"{OUTPUT_DIR}/fits/val_set2_odd2even.pdf",
        f"{OUTPUT_DIR}/fits/val_set2_even2odd.pdf",


rule cross_validation:
    """Cross-validate the fit-based optimizer using odd/even event splitting.

    Requires:
      1. Step 2 cache — run from analysis/: uv run snakemake load_data -j1
      2. fit_based_optimizer output — run from analysis/studies/fit_based_optimizer/: uv run snakemake -j1
    """
    input:
        step2    = f"{ANALYSIS_DIR}/analysis_output/.step2_complete",
        ref_cuts = f"{FIT_OPT_DIR}/output/optimal_cuts.csv",
    output:
        csv_odd   = f"{OUTPUT_DIR}/scan_odd.csv",
        csv_even  = f"{OUTPUT_DIR}/scan_even.csv",
        summary   = f"{OUTPUT_DIR}/crossval_summary.csv",
        report    = f"{OUTPUT_DIR}/crossval_report.pdf",
        val_s1_o2e = f"{OUTPUT_DIR}/fits/val_set1_odd2even.pdf",
        val_s1_e2o = f"{OUTPUT_DIR}/fits/val_set1_even2odd.pdf",
        val_s2_o2e = f"{OUTPUT_DIR}/fits/val_set2_odd2even.pdf",
        val_s2_e2o = f"{OUTPUT_DIR}/fits/val_set2_even2odd.pdf",
    params:
        config_dir = CONFIG_DIR,
        cache_dir  = CACHE_DIR,
        output_dir = OUTPUT_DIR,
    script:
        "study_crossval_optimizer.py"
