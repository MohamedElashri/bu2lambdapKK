# Snakefile — B⁺ → Λ̄pK⁻K⁺ Charmonium Analysis Pipeline
#
# Usage:
#   snakemake -j1                          # Run full pipeline
#   snakemake -n                           # Dry run
#   snakemake validate_config              # Run single rule
#   snakemake --config years="[2016]"      # Override config
#   snakemake --dag | dot -Tpdf > dag.pdf  # Visualize DAG
#
# Standalone studies live in analysis/studies/<study_name>/ with their own Snakefiles.

configfile: "snakemake_config.yaml"

# ---------------------------------------------------------------------------
# Global configuration
# ---------------------------------------------------------------------------
CONFIG_DIR = config.get("config_dir", "config")
CACHE_DIR = config.get("cache_dir", "cache")
OUTPUT_DIR = config.get("output_dir", "analysis_output")

YEARS = config.get("years", ["2016", "2017", "2018"])
TRACK_TYPES = config.get("track_types", ["LL", "DD"])
MAGNETS = config.get("magnets", ["MD", "MU"])
STATES = config.get("states", ["jpsi", "etac", "chic0", "chic1"])
USE_MANUAL_CUTS = config.get("use_manual_cuts", False)
NO_CACHE = config.get("no_cache", False)

# ---------------------------------------------------------------------------
# Config file list (all 11 TOML files)
# ---------------------------------------------------------------------------
CONFIG_FILES = [
    f"{CONFIG_DIR}/{f}"
    for f in [
        "physics.toml",
        "detector.toml",
        "fitting.toml",
        "selection.toml",
        "triggers.toml",
        "data.toml",
        "efficiencies.toml",
        "paths.toml",
        "luminosity.toml",
        "branching_fractions.toml",
        "particles.toml",
    ]
]

# ---------------------------------------------------------------------------
# rule all — final targets
# ---------------------------------------------------------------------------
rule all:
    input:
        f"{OUTPUT_DIR}/tables/branching_fraction_ratios.csv",
        f"{OUTPUT_DIR}/results/final_results.md",
        f"{OUTPUT_DIR}/tables/yield_consistency.csv",
        f"{OUTPUT_DIR}/plots/yield_consistency_check.pdf",

# ---------------------------------------------------------------------------
# Step 1: Config validation
# ---------------------------------------------------------------------------
rule validate_config:
    input:
        CONFIG_FILES,
    output:
        touch(f"{OUTPUT_DIR}/.config_validated"),
    params:
        config_dir=CONFIG_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/validate_config.py"

# ---------------------------------------------------------------------------
# Step 2: Data/MC loading + Lambda pre-selection
# ---------------------------------------------------------------------------
rule load_data:
    input:
        f"{OUTPUT_DIR}/.config_validated",
    output:
        touch(f"{OUTPUT_DIR}/.step2_complete"),
    params:
        years=YEARS,
        track_types=TRACK_TYPES,
        magnets=MAGNETS,
        states=STATES,
        no_cache=NO_CACHE,
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
    script:
        "scripts/load_data.py"

# ---------------------------------------------------------------------------
# Step 3: Selection optimization
# ---------------------------------------------------------------------------
rule optimize_selection:
    input:
        f"{OUTPUT_DIR}/.step2_complete",
    output:
        f"{OUTPUT_DIR}/tables/optimized_cuts.csv",
    params:
        use_manual_cuts=USE_MANUAL_CUTS,
        no_cache=NO_CACHE,
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/optimize_selection.py"

# ---------------------------------------------------------------------------
# Step 4: Apply optimized cuts
# ---------------------------------------------------------------------------
rule apply_cuts:
    input:
        step2=f"{OUTPUT_DIR}/.step2_complete",
        cuts=f"{OUTPUT_DIR}/tables/optimized_cuts.csv",
    output:
        f"{OUTPUT_DIR}/tables/step4_summary.json",
    params:
        no_cache=NO_CACHE,
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/apply_cuts.py"

# ---------------------------------------------------------------------------
# Step 5: Mass fitting (RooFit)
# ---------------------------------------------------------------------------
rule mass_fitting:
    input:
        f"{OUTPUT_DIR}/tables/step4_summary.json",
    output:
        f"{OUTPUT_DIR}/tables/step5_yields.csv",
    params:
        no_cache=NO_CACHE,
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/mass_fitting.py"

# ---------------------------------------------------------------------------
# Step 6: Efficiency calculation
# ---------------------------------------------------------------------------
rule efficiency_calculation:
    input:
        summary=f"{OUTPUT_DIR}/tables/step4_summary.json",
        cuts=f"{OUTPUT_DIR}/tables/optimized_cuts.csv",
    output:
        efficiencies=f"{OUTPUT_DIR}/tables/efficiencies.csv",
        ratios=f"{OUTPUT_DIR}/tables/efficiency_ratios.csv",
    params:
        no_cache=NO_CACHE,
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/efficiency_calculation.py"

# ---------------------------------------------------------------------------
# Step 7: Branching fraction ratios
# ---------------------------------------------------------------------------
rule branching_ratios:
    input:
        yields=f"{OUTPUT_DIR}/tables/step5_yields.csv",
        efficiencies=f"{OUTPUT_DIR}/tables/efficiencies.csv",
        ratios=f"{OUTPUT_DIR}/tables/efficiency_ratios.csv",
    output:
        br_ratios=f"{OUTPUT_DIR}/tables/branching_fraction_ratios.csv",
        final_results=f"{OUTPUT_DIR}/results/final_results.md",
        consistency_csv=f"{OUTPUT_DIR}/tables/yield_consistency.csv",
        consistency_plot=f"{OUTPUT_DIR}/plots/yield_consistency_check.pdf",
    params:
        config_dir=CONFIG_DIR,
        cache_dir=CACHE_DIR,
        output_dir=OUTPUT_DIR,
    script:
        "scripts/branching_ratios.py"


# ===========================================================================
# Convenience targets (not part of the DAG)
# ===========================================================================

# ---------------------------------------------------------------------------
# Clean targets — use: snakemake clean -j1 --delete-all-output
# Or run these directly:
#   snakemake clean_cache -j1 -f
#   snakemake clean_outputs -j1 -f
#   snakemake clean_all -j1 -f
# ---------------------------------------------------------------------------
rule clean_cache:
    """Remove cached intermediate results (pickle files)."""
    shell:
        "rm -rf {CACHE_DIR}/data/*.pkl {CACHE_DIR}/metadata/*.json"

rule clean_outputs:
    """Remove output files (tables, plots, results)."""
    shell:
        "rm -rf {OUTPUT_DIR}"

rule clean_all:
    """Remove everything (cache + outputs)."""
    shell:
        "rm -rf {CACHE_DIR}/data/*.pkl {CACHE_DIR}/metadata/*.json {OUTPUT_DIR}"
